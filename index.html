<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Coach Perte de Gras</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter&display=swap');

    body {
      font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont,
                   "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background-color: #f4f4f4;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    #chat {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
    }

    .message {
      margin: 10px 0;
      padding: 10px;
      border-radius: 8px;
      max-width: 70%;
      white-space: pre-wrap;
    }

    .user {
      background-color: #d1e7dd;
      align-self: flex-end;
    }

    .bot {
      background-color: #e2e3e5;
      align-self: flex-start;
    }

    #inputArea {
      display: flex;
      padding: 10px;
      border-top: 1px solid #ccc;
      background: white;
      align-items: flex-end;
    }

    textarea#userInput {
      flex: 1;
      font-family: 'Inter', system-ui, sans-serif;
      font-size: 16px;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      resize: vertical;
      max-height: 200px;
      min-height: 40px;
      overflow-y: auto;
    }

    button {
      margin-left: 10px;
      padding: 10px;
      font-size: 16px;
      background-color: #198754;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      height: 42px;
    }
  </style>
</head>
<body>

  <div id="chat"></div>

  <div id="inputArea">
    <textarea id="userInput" placeholder="Pose ta question..." rows="2"></textarea>
    <button onclick="sendMessage()">Envoyer</button>
  </div>

  <script>
    // ==== RÉFÉRENCES DOM ====
    const chat = document.getElementById("chat");
    const input = document.getElementById("userInput");

    // ==== 1) BULLE D'ACCUEIL AFFICHÉE UNE SEULE FOIS ====
    appendMessage(
      `Salut ! Je suis ici pour t'aider à construire un plan alimentaire sur mesure pour t’aider à éliminer du poids selon un protocole très précis conçu par Alex Boily.\n\n` +
      `Peux-tu d’abord me donner les informations suivantes pour que je puisse calculer ton besoin calorique quotidien :\n` +
      `- Âge :\n` +
      `- Poids :\n` +
      `- Sexe :\n` +
      `- Taille :\n` +
      `- Décris-moi tes habitudes d’activités physiques (heures/semaine, type et intensité)\n`,
      "bot"
    );

    // ==== 2) CLAVIER ENTER POUR ENVOYER (SHIFT+ENTER pour new line) ====
    input.addEventListener("keydown", function(event) {
      if (event.key === "Enter" && !event.shiftKey) {
        event.preventDefault();
        sendMessage();
      }
    });

    // ==== 3) DÉFINITION DU systemPrompt (SANS MESSAGE D'ACCUEIL) ====
    const systemPrompt = `Tu es un assistant intelligent conçu pour aider les gens à perdre du poids selon un protocole structuré développé par Alex Boily.

Voici le protocole :
1. Calcule la dépense énergétique journalière moyenne (DEJM) avec l’âge, le poids, le sexe, la taille et l’activité physique.
2. Demande ensuite les habitudes alimentaires journalières (petit-déjeuner, déjeuner, dîner, collations) avec quantités approximatives.
3. Estime la consommation calorique moyenne actuelle.
4. Construit un plan alimentaire de 12 semaines :
   - Semaines 1–2 : +200 kcal par rapport à la consommation actuelle.
   - Puis +200 kcal chaque semaine jusqu’à atteindre 100 % de la DEJM.
   - Ensuite, –200 kcal toutes les 2 semaines jusqu’à un minimum de 65 % de la DEJM.
   - Si 65 % est atteint avant la semaine 12, maintiens ce niveau jusqu’à la fin du cycle.
5. Le plan doit respecter :
   - Le nombre de repas/collations habituels.
   - Un apport protéique de 2 g/kg de poids santé.
   - Le reste des calories réparti entre glucides et lipides.
6. Si des infos manquent, tu les demandes une à une.
7. Toujours en français, ton chaleureux, professionnel, structuré.`;

    // ==== 4) HISTORIQUE DE CONVERSATION ====
    const chatHistory = [
      { role: "system", content: systemPrompt }
    ];

    // ==== 5) FONCTIONS ====

    function appendMessage(text, sender) {
      const div = document.createElement("div");
      div.className = `message ${sender}`;
      div.innerText = text;
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
    }

    async function sendMessage() {
      const userMessage = input.value.trim();
      if (!userMessage) return;

      // affiche l'utilisateur
      appendMessage(userMessage, "user");
      input.value = "";

      // ajoute au contexte
      chatHistory.push({ role: "user", content: userMessage });

      // placeholder bot
      const placeholder = document.createElement("div");
      placeholder.className = "message bot";
      placeholder.innerText = "...";
      chat.appendChild(placeholder);
      chat.scrollTop = chat.scrollHeight;

      try {
        // appel API avec tout l'historique
        const res = await fetch("/api/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ messages: chatHistory })
        });
        const data = await res.json();

        // récupère et affiche
        const reply = data.choices?.[0]?.message?.content?.trim();
        if (reply) {
          chatHistory.push({ role: "assistant", content: reply });
          placeholder.innerText = reply;
        } else if (data.error) {
          placeholder.innerText = "Erreur OpenAI : " + data.error.message;
        } else {
          placeholder.innerText = "Erreur : réponse vide ou inattendue.";
        }
      } catch (err) {
        placeholder.innerText = "Erreur réseau : " + err.message;
      }
    }
  </script>
</body>
</html>
