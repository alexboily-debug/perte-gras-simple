<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Coach Perte de Gras</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter&display=swap');

    body {
      font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont,
                   "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background-color: #f4f4f4;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    #chat {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
    }

    .message {
      margin: 10px 0;
      padding: 10px;
      border-radius: 8px;
      max-width: 70%;
      white-space: pre-wrap;
    }

    .user {
      background-color: #d1e7dd;
      align-self: flex-end;
    }

    .bot {
      background-color: #e2e3e5;
      align-self: flex-start;
    }

    #inputArea {
      display: flex;
      padding: 10px;
      border-top: 1px solid #ccc;
      background: white;
      align-items: flex-end;
    }

    textarea#userInput {
      flex: 1;
      font-family: 'Inter', system-ui, sans-serif;
      font-size: 16px;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      resize: vertical;
      max-height: 200px;
      min-height: 40px;
      overflow-y: auto;
    }

    button {
      margin-left: 10px;
      padding: 10px;
      font-size: 16px;
      background-color: #198754;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      height: 42px;
    }
  </style>
</head>
<body>

  <div id="chat"></div>

  <div id="inputArea">
    <textarea id="userInput" placeholder="Pose ta question..." rows="2"></textarea>
    <button onclick="sendMessage()">Envoyer</button>
  </div>

  <script>
    // Références DOM
    const chat = document.getElementById("chat");
    const input = document.getElementById("userInput");

    // 1) Bulle d'accueil unique
    appendMessage(
      `Salut ! Je suis ici pour t'aider à construire un plan alimentaire sur mesure pour t’aider à éliminer du poids selon un protocole très précis conçu par Alex Boily.\n\n` +
      `Peux-tu d’abord me donner les informations suivantes pour que je puisse calculer ton besoin calorique quotidien :\n` +
      `- Âge :\n` +
      `- Poids :\n` +
      `- Sexe :\n` +
      `- Taille :\n` +
      `- Décris-moi tes habitudes d’activités physiques (heures/semaine, type et intensité)\n`,
      "bot"
    );

    // 2) Envoi au "Enter" (Shift+Enter = nouvelle ligne)
    input.addEventListener("keydown", function(event) {
      if (event.key === "Enter" && !event.shiftKey) {
        event.preventDefault();
        sendMessage();
      }
    });

    // 3) Instructions système (systemPrompt) — sans message d’accueil
    const systemPrompt = `Tu es un assistant expert en nutrition et en calcul de dépense énergétique.
    
**Important :** pour chaque calcul de DEJM (Dépense Énergétique Journalière Moyenne), tu dois :
1. Calculer d’abord le BMR (métabolisme de base) via la formule de Mifflin-St Jeor :
   - Hommes : BMR = 10×poids(kg) + 6.25×taille(cm) – 5×âge + 5
   - Femmes : BMR = 10×poids(kg) + 6.25×taille(cm) – 5×âge – 161
2. Déterminer ensuite le PAL (Physical Activity Level) en fonction du niveau d’activité :
   - Sédentaire : PAL≈1.2
   - Activité légère : PAL≈1.375
   - Activité modérée : PAL≈1.55
   - Activité intense/triathlon : PAL≈1.7–1.9 (à préciser par l’utilisateur)
3. Enfin, calculer **DEJM = BMR × PAL** (et non pas uniquement BMR).

### Protocole de création du plan sur 12 semaines :
- **Semaines 1–2** : calories = consommation actuelle + 200 kcal  
- **Semaines 3–?** : +200 kcal/semaine jusqu’à atteindre 100 % DEJM  
- **Ensuite** : –200 kcal toutes les 2 semaines jusqu’à un minimum de 65 % DEJM  
- **Si 65 % est atteint avant la semaine 12**, maintenir ce niveau jusqu’à la fin du cycle  

Le plan doit respecter les repas/collations usuels, viser 2 g de protéines/kg de poids santé, et répartir le reste en glucides/lipides.

Si des données manquent, tu les demandes une à une. Toujours en français, ton chaleureux et structuré.`;

    // 4) Historique de la conversation
    const chatHistory = [
      { role: "system", content: systemPrompt }
    ];

    // 5) appendMessage
    function appendMessage(text, sender) {
      const div = document.createElement("div");
      div.className = `message ${sender}`;
      div.innerText = text;
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
    }

    // 6) sendMessage
    async function sendMessage() {
      const userMessage = input.value.trim();
      if (!userMessage) return;

      // Affiche l'utilisateur
      appendMessage(userMessage, "user");
      input.value = "";

      // Ajoute au contexte
      chatHistory.push({ role: "user", content: userMessage });

      // Placeholder bot
      const placeholder = document.createElement("div");
      placeholder.className = "message bot";
      placeholder.innerText = "...";
      chat.appendChild(placeholder);
      chat.scrollTop = chat.scrollHeight;

      try {
        const res = await fetch("/api/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ messages: chatHistory })
        });
        const data = await res.json();

        // Récupère la réponse
        const reply = data.choices?.[0]?.message?.content?.trim();
        if (reply) {
          chatHistory.push({ role: "assistant", content: reply });
          placeholder.innerText = reply;
        } else if (data.error) {
          placeholder.innerText = "Erreur OpenAI : " + data.error.message;
        } else {
          placeholder.innerText = "Erreur : réponse vide ou inattendue.";
        }
      } catch (err) {
        placeholder.innerText = "Erreur réseau : " + err.message;
      }
    }
  </script>
</body>
</html>
