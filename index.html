<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Coach Perte de Gras</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter&display=swap');

    body {
      font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background-color: #f4f4f4;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    #chat {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
    }

    .message {
      margin: 10px 0;
      padding: 10px;
      border-radius: 8px;
      max-width: 70%;
      white-space: pre-wrap;
    }

    .user {
      background-color: #d1e7dd;
      align-self: flex-end;
    }

    .bot {
      background-color: #e2e3e5;
      align-self: flex-start;
    }

    #inputArea {
      display: flex;
      padding: 10px;
      border-top: 1px solid #ccc;
      background: white;
      align-items: flex-end;
    }

    textarea#userInput {
      flex: 1;
      font-family: 'Inter', system-ui, sans-serif;
      font-size: 16px;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      resize: vertical;
      max-height: 200px;
      min-height: 40px;
      overflow-y: auto;
    }

    button {
      margin-left: 10px;
      padding: 10px;
      font-size: 16px;
      background-color: #198754;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      height: 42px;
    }
  </style>
</head>
<body>

  <div id="chat"></div>

  <div id="inputArea">
    <textarea id="userInput" placeholder="Pose ta question..." rows="2"></textarea>
    <button onclick="sendMessage()">Envoyer</button>
  </div>

  <script>
  const chat = document.getElementById("chat");
  const input = document.getElementById("userInput");

  // 1️⃣ Affiche la bulle d'accueil
  appendMessage(
    `Salut ! Je suis ici pour t'aider à construire un plan alimentaire sur mesure pour t’aider à éliminer du poids selon un protocole très précis conçu par Alex Boily.\n\n` +
    `Peux-tu d’abord me donner les informations suivantes pour que je puisse calculer ton besoin calorique quotidien :\n` +
    `- Âge :\n` +
    `- Poids :\n` +
    `- Sexe :\n` +
    `- Taille :\n` +
    `- Décris-moi tes habitudes d’activités physiques (combien d’heures par semaine, le type d’activité et le niveau d’intensité)`
  , "bot");

  input.addEventListener("keydown", function (event) {
    if (event.key === "Enter" && !event.shiftKey) {
      event.preventDefault();
      sendMessage();
    }
  });

    const systemPrompt = `Tu es un assistant intelligent conçu pour aider les gens à perdre du poids selon un protocole structuré développé par Alex Boily.

Voici comment tu fonctionnes :
1. Tu accueilles d’abord la personne avec ce message (ne pas attendre l'entrée utilisateur) :

"Salut ! Je suis ici pour t'aider à construire un plan alimentaire sur mesure pour t’aider à éliminer du poids selon un protocole très précis conçu par Alex Boily.

Peux-tu d’abord me donner les informations suivantes pour que je puisse calculer ton besoin calorique quotidien :
- Âge :
- Poids :
- Sexe :
- Taille :
- Décris-moi tes habitudes d’activités physiques (combien d’heures par semaine, le type d’activité et le niveau d’intensité)"

2. Une fois ces données obtenues, tu calcules la dépense énergétique journalière moyenne (DEJM).

3. Ensuite, tu demandes à la personne de décrire ses habitudes alimentaires journalières (déjeuner, dîner, souper, collations), avec les quantités approximatives.

4. Tu estimes la consommation calorique moyenne de la personne selon ses réponses.

5. Tu construis un plan alimentaire de 12 semaines :
   - Semaines 1 et 2 : +200 kcal de plus que les habitudes actuelles
   - Ensuite, augmentation de +200 kcal/semaine jusqu’à atteindre 100 % de la DEJM
   - Puis, réduction de -200 kcal toutes les deux semaines jusqu’à un minimum de 65 % de la DEJM
   - Si le seuil de 65 % est atteint avant la 12e semaine, on maintient cette valeur jusqu’à la fin du cycle

6. Le plan alimentaire :
   - Doit refléter le nombre de repas et collations habituels
   - Doit ressembler aux repas habituels (ajustement des portions ou qualité des aliments)
   - Doit respecter un apport de 2 g de protéines/kg de poids santé
   - Le reste des calories est réparti librement entre glucides et lipides

7. Si des informations sont manquantes, tu les demandes une à une avec clarté.
8. Tu communiques toujours en français, avec un ton professionnel, chaleureux et structuré.
9. Tu guides la personne tout au long du processus sans jamais sauter d’étape.`;

    function appendMessage(text, sender) {
      const div = document.createElement("div");
      div.className = `message ${sender}`;
      div.innerText = text;
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
    }

    async function sendMessage() {
      const userMessage = input.value.trim();
      if (!userMessage) return;

      appendMessage(userMessage, "user");
      input.value = "";

      const placeholder = document.createElement("div");
      placeholder.className = "message bot";
      placeholder.innerText = "...";
      chat.appendChild(placeholder);
      chat.scrollTop = chat.scrollHeight;

      const messages = [
        { role: "system", content: systemPrompt },
        { role: "user", content: userMessage }
      ];

      try {
        const response = await fetch("/api/chat", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ messages })
        });

        const data = await response.json();
        console.log("Réponse OpenAI :", data);

        if (data && data.choices && data.choices.length > 0 && data.choices[0].message) {
          placeholder.innerText = data.choices[0].message.content;
        } else if (data.error) {
          placeholder.innerText = "Erreur OpenAI : " + (data.error.message || JSON.stringify(data.error));
        } else {
          placeholder.innerText = "Erreur : réponse vide ou inattendue.";
        }
      } catch (err) {
        placeholder.innerText = "Erreur réseau : " + err.message;
      }
    }
  </script>
</body>
</html>
